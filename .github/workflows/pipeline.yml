name: Deploy API

on:
    push:
        branches:
            - main
    release:
        types: [published]

permissions:
    id-token: write
    contents: read

env:
    AWS_REGION: us-east-1
    NODE_VERSION: 20
    DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
    RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
    COMPARE_URL: ${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}
    ENVIRONMENT: ${{ github.event_name == 'push' && 'dev' || 'prod' }}
    STACK_NAME: cards-api-${{ github.event_name == 'push' && 'dev' || 'prod' }}
    AUTH_TOKEN: ${{ github.event_name == 'push' && secrets.AUTH_TOKEN_DEV || secrets.AUTH_TOKEN_PROD }}

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Start Deployment
              continue-on-error: true
              run: |
                  echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
                  
                  COMMIT_MSG=$(git log -1 --pretty=format:'%s' | sed 's/"/\\"/g')
                  SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
                  CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l)
                  
                  curl -H "Content-Type: application/json" -X POST -d '{
                    "embeds": [{
                      "title": "Deployment Started",
                      "color": 8421504,
                      "fields": [
                        {"name": "Environment", "value": "'"${ENVIRONMENT}"'", "inline": true},
                        {"name": "Commit", "value": "[`'"$SHORT_SHA"'`]('"$COMMIT_URL"')", "inline": true},
                        {"name": "Author", "value": "${{ github.actor }}", "inline": true},
                        {"name": "Message", "value": "'"$COMMIT_MSG"'", "inline": false},
                        {"name": "Changed Files", "value": "'"$CHANGED_FILES"'", "inline": true},
                        {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true}
                      ],
                      "footer": {"text": "GitHub Actions"},
                      "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                    }]
                  }' "$DISCORD_WEBHOOK_URL"

            - name: Setup Node.js
              id: setup-node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Configure AWS Credentials
              id: configure-aws
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Setup SAM
              id: setup-sam
              uses: aws-actions/setup-sam@v2
              with:
                  use-installer: true

            - name: Cache SAM Build
              id: cache-sam
              uses: actions/cache@v4
              with:
                  path: .aws-sam
                  key: sam-${{ hashFiles('template.yaml', 'src/**', 'package-lock.json', 'tsconfig.json') }}
                  restore-keys: sam-

            - name: Install Dependencies
              id: install-deps
              run: npm ci

            - name: SAM Build
              id: sam-build
              run: |
                  echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV
                  sam build
                  echo "BUILD_END=$(date +%s)" >> $GITHUB_ENV

            - name: Deploy to AWS
              id: deploy
              run: |
                  sam deploy \
                    --stack-name ${{ env.STACK_NAME }} \
                    --parameter-overrides Env=${{ env.ENVIRONMENT }} AuthToken=${{ env.AUTH_TOKEN }} WafHeaderName=${{ secrets.WAF_HEADER_NAME }} WafHeaderValue=${{ secrets.WAF_HEADER_VALUE }} \
                    --capabilities CAPABILITY_IAM \
                    --resolve-s3 \
                    --no-confirm-changeset \
                    --no-fail-on-empty-changeset

            - name: Deployment Success
              if: success()
              continue-on-error: true
              run: |
                  END_TIME=$(date +%s)
                  TOTAL_DURATION=$((END_TIME - START_TIME))
                  BUILD_DURATION=$((BUILD_END - BUILD_START))
                  DEPLOY_DURATION=$((END_TIME - BUILD_END))
                  SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
                  
                  FIELDS='[
                    {"name": "Environment", "value": "'"${ENVIRONMENT}"'", "inline": true},
                    {"name": "Stack", "value": "`${{ env.STACK_NAME }}`", "inline": true},
                    {"name": "Region", "value": "${{ env.AWS_REGION }}", "inline": true},
                    {"name": "Build Time", "value": "'"${BUILD_DURATION}s"'", "inline": true},
                    {"name": "Deploy Time", "value": "'"${DEPLOY_DURATION}s"'", "inline": true},
                    {"name": "Total Time", "value": "'"${TOTAL_DURATION}s"'", "inline": true}
                  ]'
                  
                  if [ "${{ github.event_name }}" = "release" ]; then
                    FIELDS=$(echo "$FIELDS" | sed 's/]$/,{"name":"Release","value":"${{ github.event.release.tag_name }}","inline":true}]/')
                  fi
                  
                  curl -H "Content-Type: application/json" -X POST -d '{
                    "embeds": [{
                      "title": "Deployment Successful",
                      "description": "[View Changes]('"$COMPARE_URL"') • [Commit]('"$COMMIT_URL"') • [Logs]('"$RUN_URL"')",
                      "color": 5763719,
                      "fields": '"$FIELDS"',
                      "footer": {"text": "Deployed by ${{ github.actor }}"},
                      "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                    }]
                  }' "$DISCORD_WEBHOOK_URL"

            - name: Deployment Failed
              if: failure()
              continue-on-error: true
              run: |
                  END_TIME=$(date +%s)
                  TOTAL_DURATION=$((END_TIME - START_TIME))
                  SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
                  COMMIT_MSG=$(git log -1 --pretty=format:'%s' | sed 's/"/\\"/g')
                  
                  FAILED_STEP=$(echo '${{ toJson(steps) }}' | jq -r 'to_entries[] | select(.value.outcome == "failure") | .key' | head -1)
                  
                  curl -H "Content-Type: application/json" -X POST -d '{
                    "embeds": [{
                      "title": "Deployment Failed",
                      "description": "[View Logs]('"$RUN_URL"') • [Commit]('"$COMMIT_URL"')",
                      "color": 15158332,
                      "fields": [
                        {"name": "Environment", "value": "'"${ENVIRONMENT}"'", "inline": true},
                        {"name": "Failed At", "value": "'"${FAILED_STEP:-Unknown}"'", "inline": true},
                        {"name": "Duration", "value": "'"${TOTAL_DURATION}s"'", "inline": true},
                        {"name": "Commit", "value": "[`'"$SHORT_SHA"'`]('"$COMMIT_URL"')", "inline": true},
                        {"name": "Author", "value": "${{ github.actor }}", "inline": true},
                        {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                        {"name": "Message", "value": "'"$COMMIT_MSG"'", "inline": false}
                      ],
                      "footer": {"text": "Check logs for details"},
                      "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                    }]
                  }' "$DISCORD_WEBHOOK_URL"
